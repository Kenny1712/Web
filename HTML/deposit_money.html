<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N·∫°p ti·ªÅn</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="../Css/deposit_money.css" />
  </head>
  <body>
    <div class="nap-container">
      <h2>N·∫°p ti·ªÅn</h2>

      <div class="sodu-box">S·ªë d∆∞ hi·ªán t·∫°i: <span id="balance">0</span> ƒë</div>

      <div class="mb-3">
        <label for="amount" class="form-label">Ch·ªçn s·ªë ti·ªÅn</label>
        <select id="amount" class="form-select">
          <option value="10000">10.000 ƒë</option>
          <option value="20000">20.000 ƒë</option>
          <option value="50000">50.000 ƒë</option>
          <option value="100000">100.000 ƒë</option>
          <option value="200000">200.000 ƒë</option>
          <option value="500000">500.000 ƒë</option>
          <option value="500000000000">500.000.000.000 ƒë</option>
        </select>
      </div>

      <div class="mb-4">
        <label for="method" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
        <select id="method" class="form-select" onchange="updatePaymentFields()">
          <option value="MOMO">V√≠ MoMo</option>
          <option value="BANK">Ng√¢n h√†ng</option>
          <option value="CARD">Th·∫ª c√†o</option>
        </select>
      </div>

      <!-- Dynamic field container -->
      <div id="extraFields" class="mb-4"></div>

      <button class="btn btn-nap" onclick="handleNapTien()">üí∞ X√°c nh·∫≠n n·∫°p</button>
      <button class="btn btn-nap2" onclick="window.location.href='../HTML/index.html'">
        üè† Quay v·ªÅ trang ch·ªß
      </button>

      <div class="history-box">
        <h4>L·ªãch s·ª≠ n·∫°p</h4>
        <div id="historyList"></div>
      </div>
    </div>

    <!-- Modal x√°c nh·∫≠n -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content modal-confirm">
          <div class="modal-body">
            <h5>‚úÖ N·∫°p ti·ªÅn th√†nh c√¥ng!</h5>
            <p id="confirmMessage"></p>
            <button
              type="button"
              class="btn btn-success mt-3"
              data-bs-dismiss="modal"
              onclick="window.location.href='../HTML/Index.html'"
            >
              Quay v·ªÅ trang ch·ªß
            </button>
            <button type="button" class="btn btn-success mt-3" data-bs-dismiss="modal">
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const sodu = localStorage.getItem("userBalance") || 0;
        document.getElementById("balance").textContent = Number(sodu).toLocaleString();
        loadHistory();
        updatePaymentFields();
      });

      function handleNapTien() {
        const amount = Number(document.getElementById("amount").value);
        const method = document.getElementById("method").value;
        const currentUser = localStorage.getItem("currentUser") || "Kh√°ch";

        if (method === "CARD") {
          const cardCode = document.getElementById("cardCode")?.value.trim();
          const cardSerial = document.getElementById("cardSerial")?.value.trim();

          if (!cardCode || !cardSerial) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ th·∫ª v√† s·ªë seri!");
            return;
          }

          if (!/^[0-9]{10,16}$/.test(cardCode)) {
            alert("‚ùó M√£ th·∫ª ph·∫£i l√† d√£y s·ªë t·ª´ 10 ƒë·∫øn 16 ch·ªØ s·ªë.");
            return;
          }

          if (!/^[0-9]{5,20}$/.test(cardSerial)) {
            alert("‚ùó S·ªë seri ph·∫£i l√† d√£y s·ªë t·ª´ 5 ƒë·∫øn 20 ch·ªØ s·ªë.");
            return;
          }
        }

        const currentBalance = Number(localStorage.getItem("userBalance") || 0);
        const newBalance = currentBalance + amount;
        localStorage.setItem("userBalance", newBalance);
        document.getElementById("balance").textContent = newBalance.toLocaleString();

        const history = JSON.parse(localStorage.getItem("napHistory") || "[]");
        const time = new Date().toLocaleString("vi-VN");
        history.unshift(`${time} - ${currentUser} ƒë√£ n·∫°p ${amount.toLocaleString()} ƒë qua ${method}`);
        localStorage.setItem("napHistory", JSON.stringify(history));

        document.getElementById("confirmMessage").textContent =
          `${currentUser} ƒë√£ n·∫°p ${amount.toLocaleString()} ƒë qua ${method}. S·ªë d∆∞ m·ªõi: ${newBalance.toLocaleString()} ƒë.`;

        const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
        modal.show();

        makeCoinsRain();
        loadHistory();
      }

      function updatePaymentFields() {
        const method = document.getElementById("method").value;
        const container = document.getElementById("extraFields");
        container.innerHTML = "";

        if (method === "BANK") {
          container.innerHTML = `
            <div style="background: linear-gradient(to right, #2c2c2c, #1b1b1b); border: 1px solid #444; border-radius: 10px; padding: 16px; color: #fff;">
              <p><strong>Ng√¢n h√†ng:</strong> Techcombank</p>
              <p><strong>Ch·ªß t√†i kho·∫£n:</strong> ƒê·ªó Ch√≠ B√¨nh</p>
              <p><strong>S·ªë t√†i kho·∫£n:</strong> 1234 5678 910</p>
              <img src="../Img/qr.svg" alt="QR code" style="width: 100px; background-color:white; height: 100px; margin-top: 10px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.5);" />
            </div>
          `;
        }

        if (method === "CARD") {
          container.innerHTML = `
            <div class="mb-3">
              <label class="form-label">M√£ th·∫ª c√†o</label>
              <input type="text" id="cardCode" class="form-control" placeholder="Nh·∫≠p m√£ th·∫ª" />
            </div>
            <div class="mb-3">
              <label class="form-label">S·ªë seri</label>
              <input type="text" id="cardSerial" class="form-control" placeholder="Nh·∫≠p s·ªë seri" />
            </div>
          `;
        }
      }

      function loadHistory() {
        const historyList = document.getElementById("historyList");
        const history = JSON.parse(localStorage.getItem("napHistory") || "[]");
        historyList.innerHTML = history.length
          ? history.map((item) => `<div class='history-item'>${item}</div>`).join("")
          : "<em>Ch∆∞a c√≥ giao d·ªãch n√†o.</em>";
      }

      function makeCoinsRain() {
        for (let i = 0; i < 20; i++) {
          const coin = document.createElement("div");
          coin.classList.add("coin");
          coin.style.left = Math.random() * 100 + "vw";
          coin.style.animationDuration = 2 + Math.random() * 1.5 + "s";
          document.body.appendChild(coin);
          setTimeout(() => coin.remove(), 3000);
        }
      }
    </script>
  </body>
</html>
